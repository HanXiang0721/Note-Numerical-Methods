# 球面浅水模式

> Although I frequently use numerical models in my research, I have never wrote a toy model myself. After I got my Master's degree, I finally had some time and decided to build a toy model from the beginning. This toy model could help me understand the dynamic core of numerical models. This model is a very simple shallow water model on a spherical coordinate. Now let's begin!

## Maths

Gradient:

$\nabla{A}=\dfrac{\partial{A}}{\partial{r}}\vec{r}+\dfrac{1}{r}\dfrac{\partial{A}}{\partial{\theta}}\vec{\theta}+\dfrac{1}{rcos\theta}\dfrac{\partial{A}}{\partial{\phi}}\vec{\phi}$

Divergence:

$\nabla\cdot\vec{A}=\dfrac{1}{r^2}\dfrac{\partial}{\partial{r}}(r^2A_r)+\dfrac{1}{rcos\theta}\dfrac{\partial}{\partial{\theta}}(A_{\theta}cos\theta)+\dfrac{1}{rcos\theta}\dfrac{\partial}{\partial{\phi}}A_{\phi}$

## Assumptions

* constant density
* topography is much smaller than the radius of sphere
* the fluid is shallow
* if $r$ is not in the derivative, then $r$ is nearly equal to $R_e+H$ or $R_e$. This means that the depth of fluid is much smaller than $R_e+H$ and $R_e$ and the topography is much smaller than the planet radius $R_e$ respectively

## Dominant equations

### Continuous equation

The basic continuous equation is:

$\dfrac{d\rho}{dt}+\rho\nabla\cdot\vec{V}=0$

As we assume constant density, thus:

$\nabla\cdot\vec{V}=\dfrac{1}{r^2}\dfrac{\partial}{\partial{r}}(r^2V_r)+\dfrac{1}{rcos\theta}\dfrac{\partial}{\partial{\theta}}(V_{\theta}cos\theta)+\dfrac{1}{rcos\theta}\dfrac{\partial}{\partial{\phi}}V_{\phi}=0$

Multiply $r^2$ to both sides:

$r^2\nabla\cdot\vec{V}=\dfrac{\partial}{\partial{r}}(r^2V_r)+\dfrac{r}{cos\theta}\dfrac{\partial}{\partial{\theta}}(V_{\theta}cos\theta)+\dfrac{r}{cos\theta}\dfrac{\partial}{\partial{\phi}}V_{\phi}=0$

Integrating this equation from $R_e+H$ to $R_e+H+h$, where $R_e$ is the radius of sphere, $H$ is topography and $h$ is the depth of the fluid:

$\displaystyle{\int_{R_e+H}^{R_e+H+h}r^2\nabla\cdot\vec{V}dr}=0$

The first item in the integration is a little bit complex:

$\displaystyle{\int_{R_e+H}^{R_e+H+h}\dfrac{\partial}{\partial{r}}(r^2V_r)dr}$

As $V_r=0$ at the surface of the planet, this item actually is the evaluation of $r^2V_r$ at $R_e+H+h$, which is approximated as the following:

$\displaystyle{\int_{R_e+H}^{R_e+H+h}\dfrac{\partial}{\partial{r}}(r^2V_r)dr}=(R_e+H)^2V_r=(R_e+H)^2\dfrac{dh}{dt}$

The second and third item is relatively simple, after integration, they could be expressed as:

$h(R_e+H)\dfrac{1}{cos\theta}\dfrac{\partial}{\partial{\theta}}(V_{\theta}cos\theta)$

and

$h(R_e+H)\dfrac{1}{cos\theta}\dfrac{\partial}{\partial{\phi}}V_{\phi}$

Combine the three items together and after some algebra, we have:

$\dfrac{\partial{h}}{\partial{t}}+\dfrac{1}{R_{e}cos\theta}\dfrac{\partial}{\partial{\theta}}(hV_{\theta}cos\theta)+\dfrac{1}{R_{e}cos\theta}\dfrac{\partial}{\partial{\phi}}(hV_{\phi})=0$

### Horizontal momentum equation

Based on previous analysis, in fact, we have already make the fluid flow on a spherical curvature (there are no radius velocity). Now, we are able to write the horizontal momentum equation directly:

$\dfrac{\partial{V_{\phi}}}{\partial{t}}+\dfrac{V_{\theta}}{R_e}\dfrac{\partial{V_{\phi}}}{\partial{\theta}}+\dfrac{V_{\phi}}{R_ecos\theta}\dfrac{\partial{V_{\phi}}}{\partial{\phi}}=fV_\theta-\dfrac{g}{R_ecos\theta}\dfrac{\partial{H+h}}{\partial{\phi}}$

$\dfrac{\partial{V_{\theta}}}{\partial{t}}+\dfrac{V_{\theta}}{R_e}\dfrac{\partial{V_{\theta}}}{\partial{\theta}}+\dfrac{V_{\phi}}{R_ecos\theta}\dfrac{\partial{V_{\theta}}}{\partial{\phi}}=-fV_\phi-\dfrac{g}{R_e}\dfrac{\partial{H+h}}{\partial{\theta}}$

We should notice that the last term on the right hand side still contain the topography.

After some algebra, we have the horizontal momentum equation:

$\dfrac{\partial{hV_\theta }}{\partial{t}}+\dfrac{1}{R_ecos\theta}\dfrac{\partial}{\partial{\theta}}(hV_{\theta}^2+\dfrac{gh^2cos\theta}{2})+\dfrac{1}{R_ecos\theta}\dfrac{\partial}{\partial{\phi}}(hV_\phi V_\theta)=-\dfrac{gh}{R_e}\dfrac{\partial{H}}{\partial{\theta}}-hfV_\phi$

$\dfrac{\partial{hV_\phi}}{\partial{t}}+\dfrac{1}{R_ecos\theta}\dfrac{\partial}{\partial{\theta}}(hV_\phi V_\theta cos\theta)+\dfrac{1}{R_ecos\theta}\dfrac{\partial}{\partial{\phi}}(hV_{\phi}^2+\dfrac{gh^2}{2})=-\dfrac{gh}{R_e ocs\theta}\dfrac{\partial{H}}{\partial{\phi}}+hfV_\theta$

### Viscous dissipation

Well, this part is quite simple...The viscous coefficient multiply the Laplacian of a certain variable (like u wind)...

## Numerical Solution

### Lax-Wendroff scheme
As written in the famous book "Numerical Methods for Fluid Dynamics: With Application to Geophysics", the Lax-Wendroff scheme could be expressed in two steps:

The first step:

$\dfrac{\phi_{j+\frac{1}{2}}^{n+\frac{1}{2}}-\dfrac{1}{2}(\phi_{j+1}^n+\phi_j^n)}{\dfrac{1}{2}\Delta t}=-c(\dfrac{\phi_{j+1}^n-\phi_{j}^n}{\Delta x})$

$\dfrac{\phi_{j-\frac{1}{2}}^{n+\frac{1}{2}}-\dfrac{1}{2}(\phi_{j}^n+\phi_{j-1}^n)}{\dfrac{1}{2}\Delta t}=-c(\dfrac{\phi_{j}^n-\phi_{j-1}^n}{\Delta x})$

In the second step:

$\phi_j^{n+1}$ is computed from: 

 $\dfrac{\phi_{j}^{n+1}-\phi_{j}^{n}}{\Delta t}=-c(\dfrac{\phi_{j+\frac{1}{2}}^{n+\frac{1}{2}}-\phi_{j-\frac{1}{2}}^{n+\frac{1}{2}}}{\Delta x})$

Now, we could use the above formulae to deal with the continuous equation and horizontal momentum equation. Remember we do not use the staggered grid this time.

## Coding details

### Lax-Wendroff scheme

$\dfrac{\partial{h}}{\partial{t}}+\dfrac{1}{R_{e}cos\theta}\dfrac{\partial}{\partial{\theta}}(hV_{\theta}cos\theta)+\dfrac{1}{R_{e}cos\theta}\dfrac{\partial}{\partial{\phi}}(hV_{\phi})=0$

The first two step in Lax-Wendroff scheme is actually calculate the value in the mid points of time level and spatial grid level.

Thus, we could use one array to store the mid-point field, let's denote it as `h_mid_xt` and `h_mid_yt` in x direction and y direction:

```python
h_mid_xt = 0.5 * (h[1:nx,:] + h[0:nx-1,:]) - (0.5 * dt / (0.5 * (dx[1:nx,:] + dx[0:nx-1,:]))) * (uh[1:nx,:] - uh[0:nx-1,:])
h_mid_yt = 0.5 * (h[:,1:ny] + h[:,0:ny-1]) - (0.5 * dt / (0.5 * (dy1[:,1:ny] + dy1[:,0:ny-1]))) * (vh1[:,1:ny] - vh1[:,0:ny-1])
```

Momentum equation is also similar to continuous equation.

After all these mid point value is calculated, we could use these mid points to make forecast:

```python
h_new = h[1:nx-1,1:ny-1] - (dt / (0.5 * (dx[1:nx-1,1:ny-1] + dx[0:nx-2,1:ny-1]))) * (uh_mid_xt[1:nx-1,1:ny-1] - uh_mid_xt[0:nx-2,1:ny-1]) - (dt / (0.5 * (dy1[1:nx-1,1:ny-1] + dy1[1:nx-1,0:ny-2]))) * (vh_mid_yt[1:nx-1,1:ny-1] * c_mid_yt[1:nx-1,1:ny-1] - vh_mid_yt[1:nx-1,0:ny-2] * c_mid_yt[1:nx-1,0:ny-2])
```

### Viscous dissipation

The viscous dissipation is the Laplacian of a field, and we could use the numpy to simplify the code just by using gradient twice. We should remember that fields are not necessarily square matrix, some more simple way perhaps not applicable under this circumstance.

```python
du_dx, du_dy = np.gradient(utmp)
du_dx[1:nx+1,1:ny+1] = du_dx[1:nx+1,1:ny+1] / dx
du_dy[1:nx+1,1:ny+1] = du_dy[1:nx+1,1:ny+1] / dy

du_dx2, du_dxdy = np.gradient(du_dx)
du_dxdy, du_dy2 = np.gradient(du_dy)
du_dx2[1:nx+1,1:ny+1] = du_dx2[1:nx+1,1:ny+1] / dx
du_dy2[1:nx+1,1:ny+1] = du_dy2[1:nx+1,1:ny+1] / dy
```

### Object orient

Python is an object orient language. Thus, we could use this feature to make our code more logical. As this is a toy model, initialization and solution is relatively simple. Thus, we could use a class to initialize the model, and use another class to solve the model.

```python
class Initialization(object):
    def __init__(self, **kwargs)

class Solution(Initialization)
    def __init__(self, **kwargs)

    def run(self)
```

## Code

[shallow-water-model.zip](./shallow-water-model.zip)



